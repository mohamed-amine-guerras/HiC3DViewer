$(document).ready(function(){function e(){var e,r;for(r=Sr.children.length-1;r>=0;r--)e=Sr.children[r],e!==Wr&&Sr.remove(e);for(r=Dr.children.length-1;r>=0;r--)e=Dr.children[r],e!==Wr&&Dr.remove(e);j=null;var t="div#regionInfo";$(t).empty()}function r(e){N=new THREE.Object3D,N.add(t(new THREE.Vector3(0,0,0),new THREE.Vector3(e,0,0),14102567,!1)),N.add(t(new THREE.Vector3(0,0,0),new THREE.Vector3(-e,0,0),14102567,!0)),N.add(t(new THREE.Vector3(0,0,0),new THREE.Vector3(0,e,0),6733155,!1)),N.add(t(new THREE.Vector3(0,0,0),new THREE.Vector3(0,-e,0),6733155,!0)),N.add(t(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,e),3311805,!1)),N.add(t(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,-e),3311805,!0)),J=new THREE.Object3D,Z=new THREE.Mesh(new THREE.TextGeometry("X",{size:e/20,height:1,curveSegments:6,font:"helvetiker",weight:"normal",style:"normal"}),new THREE.MeshBasicMaterial({color:16711680})),Z.position.set(e+e/20,0,0),W=new THREE.Mesh(new THREE.TextGeometry("Y",{size:e/20,height:1,curveSegments:6,font:"helvetiker",weight:"normal",style:"normal"}),new THREE.MeshBasicMaterial({color:65280})),W.position.set(0,e+e/20,0),K=new THREE.Mesh(new THREE.TextGeometry("Z",{size:e/20,height:1,curveSegments:6,font:"helvetiker",weight:"normal",style:"normal"}),new THREE.MeshBasicMaterial({color:255})),K.position.set(0,0,e+e/20),J.add(Z),J.add(W),J.add(K),N.add(J)}function t(e,r,t,n){var o,a=new THREE.Geometry;o=n?new THREE.LineDashedMaterial({linewidth:3,color:t,dashSize:3,gapSize:3}):new THREE.LineBasicMaterial({linewidth:3,color:t}),a.vertices.push(e.clone()),a.vertices.push(r.clone()),a.computeLineDistances();var i=new THREE.Line(a,o,THREE.LinePieces);return i}function n(e,r){var t=e.split("	"),n=r.split("	"),o=parseInt(t[0])-parseInt(n[0]);return 0==o?parseInt(t[1]-parseInt(n[1])):o}function o(e){var r,t,n,o,a,i,l,s,c,d;r=dr[e+1][0]-dr[e][0],o=dr[e+1][1]-dr[e][1],l=dr[e+1][2]-dr[e][2],0==r?(t=1,a=0,s=0):(t=(o-l)/r,a=-1,s=1),n=o*s-a*l,i=t*l-r*s,c=r*a-t*o,d=2*Math.sqrt(t*t+a*a+s*s),t/=d,a/=d,s/=d,Nr[0][0]=dr[e][0]+t*Mr,Nr[0][1]=dr[e][1]+a*Mr,Nr[0][2]=dr[e][2]+s*Mr,Nr[2][0]=dr[e][0]-t*Mr,Nr[2][1]=dr[e][1]-a*Mr,Nr[2][2]=dr[e][2]-s*Mr,d=2*Math.sqrt(n*n+i*i+c*c),n/=-d,i/=-d,c/=-d,Nr[1][0]=dr[e][0]+n*Mr,Nr[1][1]=dr[e][1]+i*Mr,Nr[1][2]=dr[e][2]+c*Mr,Nr[3][0]=dr[e][0]-n*Mr,Nr[3][1]=dr[e][1]-i*Mr,Nr[3][2]=dr[e][2]-c*Mr}function a(e){var r,t,n,o,a,i,l,s,c,d,h;if(r=dr[e+1][0]-dr[e][0],o=dr[e+1][1]-dr[e][1],l=dr[e+1][2]-dr[e][2],t=Nr[0][0]-dr[e][0],a=Nr[0][1]-dr[e][1],s=Nr[0][2]-dr[e][2],h=Math.sqrt(r*r+o*o+l*l),0==h)for(var f=0;4>f;f++)for(var g=0;3>g;g++)Nr[f+4][g]=Nr[f][g];else d=(r*t+o*a+l*s)/h,n=Nr[0][0]+r-d*r/h,i=Nr[0][1]+o-d*o/h,c=Nr[0][2]+l-d*l/h,t=n-dr[e+1][0],a=i-dr[e+1][1],s=c-dr[e+1][2],n=o*s-a*l,i=t*l-r*s,c=r*a-t*o,d=2*Math.sqrt(t*t+a*a+s*s),t/=d,a/=d,s/=d,Nr[4][0]=dr[e+1][0]+t*Mr,Nr[4][1]=dr[e+1][1]+a*Mr,Nr[4][2]=dr[e+1][2]+s*Mr,Nr[6][0]=dr[e+1][0]-t*Mr,Nr[6][1]=dr[e+1][1]-a*Mr,Nr[6][2]=dr[e+1][2]-s*Mr,d=2*Math.sqrt(n*n+i*i+c*c),n/=-d,i/=-d,c/=-d,Nr[5][0]=dr[e+1][0]+n*Mr,Nr[5][1]=dr[e+1][1]+i*Mr,Nr[5][2]=dr[e+1][2]+c*Mr,Nr[7][0]=dr[e+1][0]-n*Mr,Nr[7][1]=dr[e+1][1]-i*Mr,Nr[7][2]=dr[e+1][2]-c*Mr}function l(){for(var e=0;8>e;e++)Nr[e]=new Float32Array(3);for(var r=0;r<ar.length-1;r++){o(ar[r]),sr[r]=new THREE.BufferGeometry,cr[r]=new Float32Array(3*(ar[r+1]-ar[r]-1)*8*3+36);for(var t=0;2>t;t++)for(var n=0;3>n;n++)cr[r][9*t+3*n+0]=Nr[Ur[t][n]][0],cr[r][9*t+3*n+1]=Nr[Ur[t][n]][1],cr[r][9*t+3*n+2]=Nr[Ur[t][n]][2];for(var e=ar[r];e<ar[r+1]-1;e++){a(e);for(var t=0;8>t;t++)for(var n=0;3>n;n++)cr[r][18+72*(e-ar[r])+9*t+3*n+0]=Nr[qr[t][n]][0],cr[r][18+72*(e-ar[r])+9*t+3*n+1]=Nr[qr[t][n]][1],cr[r][18+72*(e-ar[r])+9*t+3*n+2]=Nr[qr[t][n]][2];for(var t=0;4>t;t++)for(var n=0;3>n;n++)Nr[t][n]=Nr[t+4][n]}for(var t=2;4>t;t++)for(var n=0;3>n;n++)cr[r][3*(ar[r+1]-ar[r]-1)*8*3+9*t+3*n+0]=Nr[Ur[t][n]][0],cr[r][3*(ar[r+1]-ar[r]-1)*8*3+9*t+3*n+1]=Nr[Ur[t][n]][1],cr[r][3*(ar[r+1]-ar[r]-1)*8*3+9*t+3*n+2]=Nr[Ur[t][n]][2];sr[r].addAttribute("position",new THREE.BufferAttribute(cr[r],3)),sr[r].computeBoundingSphere(),nr[r]=new THREE.Mesh(sr[r],new THREE.MeshBasicMaterial({color:new THREE.Color(Pr[r]),combine:THREE.MixOperation,side:THREE.DoubleSide})),Sr.add(nr[r])}}function s(){for(var e=0;e<ar.length-1;e++){for(var r=new THREE.BufferGeometry,t=new Float32Array(3*(ar[e+1]-ar[e])),n=ar[e];n<ar[e+1];n++)t[3*(n-ar[e])+0]=dr[n][0],t[3*(n-ar[e])+1]=dr[n][1],t[3*(n-ar[e])+2]=dr[n][2];r.addAttribute("position",new THREE.BufferAttribute(t,3)),r.computeBoundingSphere(),nr[e]=new THREE.Line(r,new THREE.LineBasicMaterial({color:new THREE.Color(Pr[e]),combine:THREE.MixOperation})),Sr.add(nr[e])}}function c(e){nr=new Array,mr?s():l(),y(e),Qr.target=new THREE.Vector3(0,0,0)}function d(){for(var e,r,t,n,o,a=0;a<ar.length-1;a++){Br[a]=new Array;for(var i=0;i<ar.length-1;i++){Br[a][i]=new Array;for(var l=0,s=0;20>s;s++,l++)for(Br[a][i][s]=new THREE.Color(Ir(l)),e=nr[a].material.color,r=nr[i].material.color,t=new THREE.Color(1,1,0),n=new THREE.Color(1,1,1),o=new THREE.Color(0,0,0);Math.sqrt(Math.pow(Br[a][i][s].r-e.r,2)+Math.pow(Br[a][i][s].g-e.g,2)+Math.pow(Br[a][i][s].b-e.b,2))<.25||Math.sqrt(Math.pow(Br[a][i][s].r-r.r,2)+Math.pow(Br[a][i][s].g-r.g,2)+Math.pow(Br[a][i][s].b-r.b,2))<.25||Math.sqrt(Math.pow(Br[a][i][s].r-t.r,2)+Math.pow(Br[a][i][s].g-t.g,2)+Math.pow(Br[a][i][s].b-t.b,2))<.25||Math.sqrt(Math.pow(Br[a][i][s].r-n.r,2)+Math.pow(Br[a][i][s].g-n.g,2)+Math.pow(Br[a][i][s].b-n.b,2))<.25||Math.sqrt(Math.pow(Br[a][i][s].r-o.r,2)+Math.pow(Br[a][i][s].g-o.g,2)+Math.pow(Br[a][i][s].b-o.b,2))<.25;)l++,Br[a][i][s]=new THREE.Color(Ir(l))}}}function h(){Wr.position.z=1.2*Yr.z,Wr.position.x=1.2*Yr.x,Wr.position.y=1.2*Yr.y,Wr.lookAt({x:0,y:0,z:0}),rr=!1,r((Yr.x+Yr.y+Yr.z)/2.4),N.visible=!0,Sr.add(N)}function f(e,r){yr=null,er=null,Q=null,ar=new Array,sr=new Array,cr=new Array,V=new Array,Y=new Array,q=new Array,Vr=new THREE.Vector3(9999,9999,9999),Yr=new THREE.Vector3(-9999,-9999,-9999);var t=e.split("\n");t=t.filter(function(e){return e}),t.sort(n),dr=new Array(t.length-2),hr=new Array(t.length-2),br=1,Rr=1,pr=0,ur=0,wr=0,Tr=0,F="1",L="1";for(var o=1;o<t.length-1;o++){var a=t[o].split("	"),i=new Array(3);r?parseInt(a[0])-1 in ar||(V[ar.length]=0,Y[ar.length]=0,q[ar.length]=0,ar[ar.length]=o-1):(-1!=a[0].search("chromosome")?a[0].replace("chromosome","chr"):-1==a[0].search("chr")&&(a[0]="chr"+a[0]),a[0]in ir||(ir[a[0]]=ar.length,lr[ar.length]=a[0],a[0]=String(ar.length+1)),ir[a[0]]in ar||(V[ar.length]=0,Y[ar.length]=0,q[ar.length]=0,ar[ar.length]=o-1)),hr[o-1]=parseInt(a[1]),i[0]=parseFloat(a[2]),pr+=i[0],V[ar.length-1]+=i[0],i[1]=parseFloat(a[3]),ur+=i[1],Y[ar.length-1]+=i[1],i[2]=parseFloat(a[4]),wr+=i[2],q[ar.length-1]+=i[2],dr[o-1]=i,Vr.min(new THREE.Vector3(i[0],i[1],i[2])),Yr.max(new THREE.Vector3(i[0],i[1],i[2]))}pr/=t.length-2,ur/=t.length-2,wr/=t.length-2,hr[ar.length]=hr[t.length-3]+1,ar[ar.length]=t.length-2;for(var l=0;l<ar.length-1;l++)V[l]/=ar[l+1]-ar[l],Y[l]/=ar[l+1]-ar[l],q[l]/=ar[l+1]-ar[l],V[l]-=pr,Y[l]-=ur,q[l]-=wr;for(var l=0;l<dr.length;l++)dr[l][0]-=pr,dr[l][1]-=ur,dr[l][2]-=wr;if(Yr.x-=pr,Yr.y-=ur,Yr.z-=wr,Vr.x-=pr,Vr.y-=ur,Vr.z-=wr,X&&"Others"!=X){var s="/data/"+X+"/cytobands.json";z(s)}if(r){k=new Array;for(var l=0;l<ar.length-1;l++)k[String(l+1)]=1}h(),c(r),d(),r?(hicDialog.setColor(Br),I(Xr,1,1,Tr)):hicDialog.hide(),waitingDialog.hide(),$(document).on("regionSelected",w),$(document).on("clearHic",g),$(document).on("chrChanged",p)}function g(){v(),j=null}function p(e){var r=$("select#genomes").find(":selected").text();-1!=r.search("res")&&(r=r.split("(res:")[0]),I(r,e.chr1,e.chr2,Tr),F=e.chr1,L=e.chr2,j=null,v()}function u(e,r){for(var t,n=ar[r],o=ar[r+1];o>n;){if(n==o-1)return n;if(t=Math.floor((n+o)/2),e<hr[t])o=t;else{if(!(e>=hr[t+1]))return t;n=t+1}}}function w(e){j=e,v();for(var r,t="div#regionInfo",n=String(parseInt(e.chr1)),o=0;o<e.Xcoord.length;o++){var a=e.Xcoord.length-o-1,i=u(e.Xcoord[a].start+hr[ar[parseInt(e.chr1)-1]],parseInt(e.chr1)-1),l=u(e.Xcoord[a].end+hr[ar[parseInt(e.chr1)-1]],parseInt(e.chr1)-1),s=u(e.Ycoord[a].start+hr[ar[parseInt(e.chr2)-1]],parseInt(e.chr2)-1),c=u(e.Ycoord[a].end+hr[ar[parseInt(e.chr2)-1]],parseInt(e.chr2)-1);M(i,l,Br[parseInt(e.chr1)-1][parseInt(e.chr2)-1][a],2*o+0,parseInt(e.chr1)-1),M(s,c,Br[parseInt(e.chr1)-1][parseInt(e.chr2)-1][a],2*o+1,parseInt(e.chr2)-1),e.chr1==e.chr2&&(DisplayChromosome(n,t,e.Xcoord[a].start,e.Xcoord[a].end,e.Ycoord[a].start,e.Ycoord[a].end),r={start:e.Xcoord[a].start,end:e.Xcoord[a].end},G(n,t,r,Br[parseInt(e.chr1)-1][parseInt(e.chr2)-1][a]),r={start:e.Ycoord[a].start,end:e.Ycoord[a].end},G(n,t,r,Br[parseInt(e.chr1)-1][parseInt(e.chr2)-1][a]))}}function v(){if(or)for(var e=0;e<or.length;e++)or[e].geometry.dispose(),or[e].material.dispose(),Dr.remove(or[e]);or=new Array,tr=new Array;var r="div#regionInfo";$(r).empty()}function m(){var e;for(var r in $r.__folders)if($r.__folders.hasOwnProperty(r)){var t=$r.__folders[r];t.close(),$r.__ul.removeChild(t.domElement.parentNode),delete $r.__folders[r]}for(e=0;e<$r.__controllers.length;e++)$r.__ul.removeChild($r.__controllers[e].__li);$r.__controllers=[],$r.onResize()}function E(){var e=$r.addFolder("Chromosomes visibility");e.close();var r=$r.addFolder("Chromosomes color");r.close();var t=$r.addFolder("Contact lines settings");t.close();var n={x:!1,y:!1,z:!1,"hide axes":!1,"trans-interactions":!1,"cis-interactions":!1,v:"...","chr thickness":Mr,"display in lines":mr,"HiC-Map Color":"YlOrRD","rotate speed":Hr},o=$r.addFolder("Rotate");o.add(n,"x").onChange(function(){}),o.add(n,"y").onChange(function(){}),o.add(n,"z").onChange(function(){}),o.add(n,"rotate speed",0,5).onChange(function(e){Hr=e}),o.close();var a=$r.addFolder("Others");a.add(n,"display in lines").onChange(function(e){mr=e}),a.add(n,"HiC-Map Color",["Yellow-Orange-Red","Yellow-Orange-Brown","Yellow-Green-Blue","Yellow-Green","Red","Red-Purple","Purple","Purple-Red","Purple-Blue-Green","Purple-Blue","Orange-Red","Oranges","Greys","Greens","Green-Blue","Blue-Purple","Blue-Green","Blues"]).onChange(function(e){Tr=parseInt(Cr[e])}),a.add(n,"hide axes").onChange(function(){}),a.add(n,"chr thickness",.05,5).onChange(function(e){Mr=e}),a.add(n,"trans-interactions").onChange(function(){}),a.add(n,"cis-interactions").onChange(function(){}),a.open()}function y(e){m();for(var r={},t={},n=0;n<ar.length-1;n++){var o=lr[n];r[o]=!0,t[o]=Pr[n]}var a=$r.addFolder("Chromosomes visibility"),i={"display all":!0},c=a.add(i,"display all").listen();c.onChange(function(e){k=new Array;for(var t=0;t<ar.length-1;t++){nr[t].visible=e;var n=lr[t];if(r[n]=e,$r.__folders["Chromosomes visibility"].__controllers[t+1].updateDisplay(),$r.__folders["Chromosomes visibility"].__controllers[t+1].__prev=e,e&&(k[String(t+1)]=1),or)for(var o=0;o<or.length;o++)tr[o]==t&&(or[o].visible=e)}Qr.target=new THREE.Vector3(0,0,0),Qr.update(),Wr.lookAt(new THREE.Vector3(0,0,0))});for(var n=0;n<ar.length-1;n++){var c=a.add(r,Object.keys(r)[n]).listen();c.onChange(function(e){var r=this.property;!e&&k[String(ir[r]+1)]?delete k[String(ir[r]+1)]:k[String(ir[r]+1)]=1,nr[ir[r]].visible=e,pr=0,ur=0,wr=0;var t=0;for(n=0;n<ar.length-1;n++)nr[n].visible&&(t+=ar[n+1]-ar[n],pr+=V[n]*(ar[n+1]-ar[n]),ur+=Y[n]*(ar[n+1]-ar[n]),wr+=q[n]*(ar[n+1]-ar[n]));if(pr/=t,ur/=t,wr/=t,Wr.lookAt(new THREE.Vector3(pr,ur,wr)),or)for(var o=0;o<or.length;o++)tr[o]==ir[r]&&(or[o].visible=e)})}a.close();for(var h=$r.addFolder("Chromosomes color"),n=0;n<ar.length-1;n++)h.addColor(t,Object.keys(t)[n]).onChange(function(e){var r=this.property;nr[ir[r]].material.color=new THREE.Color(e),d(),hicDialog.setColor(Br,ir)});if(h.close(),e){var f=$r.addFolder("Contact lines settings"),g={"cis-lines color":Fr,"trans-lines color":Lr,"trans-lines width":br,"cis-lines width":Rr};f.addColor(g,"cis-lines color").onChange(function(e){if(Fr=e,Q)for(var r=Q.children.length-1;r>=0;r--)Q.children[r].material.color=new THREE.Color(Fr)}),f.add(g,"cis-lines width",.1,5).onChange(function(e){if(Rr=e,Q)for(var r=Q.children.length-1;r>=0;r--)Q.children[r].material.linewidth=Rr}),f.addColor(g,"trans-lines color").onChange(function(e){if(Lr=e,er)for(var r=er.children.length-1;r>=0;r--)er.children[r].material.color=new THREE.Color(Lr)}),f.add(g,"trans-lines width",.1,5).onChange(function(e){if(br=e,er)for(var r=er.children.length-1;r>=0;r--)er.children[r].material.linewidth=br}),f.close()}var p={x:!1,y:!1,z:!1,"hide axes":!1,"trans-interactions":!1,"cis-interactions":!1,v:"...","chr thickness":Mr,"display in lines":mr,"HiC-Map Color":"YlOrRD","rotation speed":Hr},u=$r.addFolder("Rotate");u.add(p,"x").onChange(function(e){zr=e}),u.add(p,"y").onChange(function(e){Gr=e}),u.add(p,"z").onChange(function(e){_r=e}),u.add(p,"rotation speed",0,5).onChange(function(e){Hr=e}),u.close();var v=$r.addFolder("Others");v.add(p,"display in lines").onChange(function(e){mr=e;var r=new Array,t=new Array,n=new Array,o=new Array;if(nr)for(var a=0;a<nr.length;a++)nr[a].material.dispose(),nr[a].geometry.dispose(),Sr.remove(nr[a]),r[a]=nr[a].visible,n[a]=nr[a].material.color;if(or)for(var a=0;a<or.length;a++)or[a].material.dispose(),or[a].geometry.dispose(),Dr.remove(or[a]),t[a]=or[a].visible,o[a]=or[a].material.color;if(mr){if(s(),nr)for(var a=0;a<nr.length;a++)nr[a].visible=r[a],nr[a].material.color=n[a],nr[a].material.linewidth=Mr;if(j&&(w(j),or))for(var a=0;a<or.length;a++)or[a].visible=t[a],or[a].material.color=o[a],or[a].material.linewidth=Mr}else{l();for(var a=0;a<nr.length;a++)nr[a].visible=r[a],nr[a].material.color=n[a];if(j&&(w(j),or))for(var a=0;a<or.length;a++)or[a].visible=t[a],or[a].material.color=o[a]}}),v.add(p,"hide axes").onChange(function(e){N.visible=!e}),e&&v.add(p,"HiC-Map Color",["Yellow-Orange-Red","Yellow-Orange-Brown","Yellow-Green-Blue","Yellow-Green","Red","Red-Purple","Purple","Purple-Red","Purple-Blue-Green","Purple-Blue","Orange-Red","Oranges","Greys","Greens","Green-Blue","Blue-Purple","Blue-Green","Blues"]).onChange(function(e){Tr=parseInt(Cr[e]),fr&&I(fr,F,L)}),v.add(p,"chr thickness",.05,5).onChange(function(e){if(Mr=e,mr){for(var r=0;r<ar.length-1;r++)nr[r].material.linewidth=e;if(or)for(var r=0;r<or.length;r++)or[r].material.linewidth=e}else{var t=new Array,n=new Array,o=new Array,a=new Array;if(nr)for(var r=0;r<nr.length;r++)nr[r].material.dispose(),nr[r].geometry.dispose(),Sr.remove(nr[r]),t[r]=nr[r].visible,o[r]=nr[r].material.color;if(or)for(var r=0;r<or.length;r++)or[r].material.dispose(),or[r].geometry.dispose(),Dr.remove(or[r]),n[r]=or[r].visible,a[r]=or[r].material.color;l();for(var r=0;r<nr.length;r++)nr[r].visible=t[r],nr[r].material.color=o[r];if(j&&(w(j),or))for(var r=0;r<or.length;r++)or[r].visible=n[r],or[r].material.color=a[r]}}),e&&(v.add(p,"trans-interactions").onChange(function(e){e?er&&b(yr,Object.keys(k))?er.visible=e:Object.keys(k).length<=1?(waitingDialog.show("You have to select at least two chromsomes.","Error",{dialogSize:"sm",hasbtn:!0}),p["trans-interactions"]=!1):R(e):er.visible=!1}),v.add(p,"cis-interactions").onChange(function(e){Q.visible=e,rr=e})),e&&(v.add(p,"v",Object.keys(t)).name("cis interactions").onChange(function(e){T(e)}),T("chr1")),v.open()}function b(e,r){if(e.length!=r.length)return!1;for(var t=0;t<e.length;t++)if(e[t]!=r[t])return!1;return!0}function R(e){if(e){waitingDialog.show("Loading trans-interactions","Trans-interaction Generation",{dialogSize:"sm",progressType:"warning"});var r=$("#genomes option:selected").text();-1!=r.search("res:")&&(r=r.split("(res:")[0]),data={genome:r},data.chromosomes=Object.keys(k),yr=Object.keys(k);var t=Er+"/getInter";$.ajax({type:"POST",url:t,contentType:"application/json",dataType:"json",data:JSON.stringify(data),success:function(r){if(r.hasOwnProperty("error")&&(waitingDialog.hide(),waitingDialog.show(r.error,"Error",{dialogSize:"m",hasbtn:!0})),Object.keys(r).length>0){var t=100;if(r.hasOwnProperty("maxFreq")&&(t=r.maxFreq),!r.hasOwnProperty("interactions"))return;r=r.interactions,er=new THREE.Object3D;for(var n=0;n<Object.keys(r).length;n++)O(r[n].chr1-1,r[n].chr2-1,r[n].pos1,r[n].pos2,r[n].freq,t)}Sr.add(er),er.visible=e,waitingDialog.hide()},error:function(){waitingDialog.hide(),waitingDialog.show(data.error,"Error",{dialogSize:"m",hasbtn:!0})}})}}function T(e){var r=ir[e]+1,t=$("#genomes option:selected").text();-1!=t.search("res:")&&(t=t.split("(res:")[0]);var n=Er+"/getIntra/"+t+"/"+r;$.getJSON(n,function(e){if(Object.keys(e).length>0){Q&&Sr.remove(Q);var t=100;if(e.hasOwnProperty("maxFreq")&&(t=e.maxFreq),!e.hasOwnProperty("interactions"))return;e=e.interactions,Q=new THREE.Object3D;for(var n=0;n<Object.keys(e).length;n++){r=Object.keys(e)[n];for(var o=e[r],a=0;a<Object.keys(o).length;a++)O(parseInt(r)-1,parseInt(r)-1,o[a].pos1,o[a].pos2,o[a].freq,t)}}Q.visible=rr,Sr.add(Q)})}function H(e,r,t,n,i){var l=new Float32Array(3*(r-e)*8*3+36);o(e);for(var s=0;2>s;s++)for(var c=0;3>c;c++)l[9*s+3*c+0]=Nr[Ur[s][c]][0],l[9*s+3*c+1]=Nr[Ur[s][c]][1],l[9*s+3*c+2]=Nr[Ur[s][c]][2];for(var d=e;r>d;d++){a(d);for(var s=0;8>s;s++)for(var c=0;3>c;c++)l[72*(d-e)+18+9*s+3*c+0]=Nr[qr[s][c]][0],l[72*(d-e)+18+9*s+3*c+1]=Nr[qr[s][c]][1],l[72*(d-e)+18+9*s+3*c+2]=Nr[qr[s][c]][2];for(var s=0;4>s;s++)for(var c=0;3>c;c++)Nr[s][c]=Nr[s+4][c]}for(var s=2;4>s;s++)for(var c=0;3>c;c++)l[3*(r-e)*8*3+9*s+3*c+0]=Nr[Ur[s][c]][0],l[3*(r-e)*8*3+9*s+3*c+1]=Nr[Ur[s][c]][1],l[3*(r-e)*8*3+9*s+3*c+2]=Nr[Ur[s][c]][2];var h=new THREE.BufferGeometry;h.addAttribute("position",new THREE.BufferAttribute(l,3)),h.computeBoundingSphere(),or[n]=new THREE.Mesh(h,new THREE.MeshBasicMaterial({color:t,combine:THREE.MixOperation,side:THREE.DoubleSide})),tr[n]=i,or[n].visible=nr[i].visible,Dr.add(or[n])}function C(e,r,t,n,o){for(var a=new THREE.BufferGeometry,i=new Float32Array(3*(r-e)+3),l=e;r>=l;l++)i[3*(l-e)+0]=dr[l][0],i[3*(l-e)+1]=dr[l][1],i[3*(l-e)+2]=dr[l][2];a.addAttribute("position",new THREE.BufferAttribute(i,3)),a.computeBoundingSphere(),or[n]=new THREE.Line(a,new THREE.LineBasicMaterial({color:t,combine:THREE.MixOperation})),tr[n]=o,or[n].visible=nr[o].visible,Dr.add(or[n])}function M(e,r,t,n,o){mr?C(e,r,t,n,o):H(e,r,t,n,o)}function x(){if(requestAnimationFrame(x),Kr.clear(),zr||Gr||_r){var e=.5,r=.5,t=.5;if(nr)for(var n=0;n<nr.length;n++)zr&&(nr[n].rotation.x+=e/30*Hr),Gr&&(nr[n].rotation.y+=r/30*Hr),_r&&(nr[n].rotation.z+=t/30*Hr);if(or)for(var n=0;n<or.length;n++)zr&&(or[n].rotation.x+=e/30*Hr),Gr&&(or[n].rotation.y+=r/30*Hr),_r&&(or[n].rotation.z+=t/30*Hr)}er&&(zr&&(er.rotation.x+=e/30*Hr),Gr&&(er.rotation.y+=r/30*Hr),_r&&(er.rotation.z+=t/30*Hr)),Q&&(zr&&(Q.rotation.x+=e/30*Hr),Gr&&(Q.rotation.y+=r/30*Hr),_r&&(Q.rotation.z+=t/30*Hr)),J&&(Z.lookAt(Wr.position),W.lookAt(Wr.position),K.lookAt(Wr.position)),Kr.render(Sr,Wr),Kr.clearDepth(),Kr.render(Dr,Wr)}function A(){Ar=.93*$("#dis_HiC").width(),Or=.95*(window.innerHeight-100),Wr.aspect=Ar/Or,Wr.updateProjectionMatrix(),Kr.setSize(Ar,Or)}function O(e,r,t,n,o,a){var i=new Float32Array(6);i[0]=dr[ar[e]+t][0],i[1]=dr[ar[e]+t][1],i[2]=dr[ar[e]+t][2],i[3]=dr[ar[r]+n][0],i[4]=dr[ar[r]+n][1],i[5]=dr[ar[r]+n][2];var l=new THREE.BufferGeometry;if(opacity=Math.min(o,a)/a,e==r)var s=Fr;else var s=Lr;var c=new THREE.LineBasicMaterial({color:new THREE.Color(s),transparent:!0,opacity:opacity});l.addAttribute("position",new THREE.BufferAttribute(i,3));var d=new THREE.Line(l,c);e==r?Q.add(d):er.add(d)}function S(e){if(e.length){var r=e[0],t=new FileReader;t.onload=function(){v();for(var e=t.result,r=e.split("\n"),n=0;n<r.length;n++)if(""!=r[n]){for(var o,a,i,l,s=r[n].split(" "),c=0,d=0;d<s.length&&4>c;d++)""!=s[d]&&(0==c?(o=s[d],-1!=o.search("chromosome")?o.replace(/chromosome/,"chr"):-1==o.search("chr")&&(o="chr"+o)):1==c?a=u(hr[ar[ir[o]]]+parseInt(s[d]),ir[o]):2==c?i=u(hr[ar[ir[o]]]+parseInt(s[d]),ir[o]):l=parseFloat(s[d]),c++);var h=kr.clone();h.lerp(jr,l),M(a,i,h,n,ir[o])}x()},t.readAsText(r)}}function D(e){ir=new Array,lr=new Array;for(var r=e.split("\n"),t=0;t<r.length;t++)if(""!=r[t]){var n=r[t].split("	");-1!=n[0].search("chromosome")?n[0].replace(/chromosome/,"chr"):-1==n[0].search("chr")&&(n[0]="chr"+n[0]),ir[n[0]]=parseInt(n[1])-1,lr[parseInt(n[1])-1]=n[0]}}function B(r,t){if(waitingDialog.show("Loading model, please wait ....","Model Generation",{dialogSize:"sm",progressType:"warning"}),e(),0!=t){var n=Er+"/getChrNames/"+r;$.ajax({url:n,type:"GET",success:function(e){D(e),Xr=r;var t=Er+$("select#genomes").val();$.ajax({url:t,type:"GET",success:function(e){f(e,!0)}})}})}else{Xr=r;var n=Er+$("select#genomes").val();$.ajax({url:n,type:"GET",success:function(e){ir=new Array,lr=new Array,-1==e.search("locus")&&(e="chrom	locus	3D_x	3D_yD_z\n"+e),f(e,!1)}})}}function I(e,r,t){var n=Er+"/displayHic/"+e+"/"+r+"/"+t+"/"+Tr;$.getJSON(n,function(r){if(Object.keys(r).length>0){if(r.hasOwnProperty("error"))return;var t="Hi-C contact map of "+e,n=Er+"/getHicImg/"+r.imgUrl;chrIndex=r.chrInfo,hicDialog.show(t,e,n,chrIndex,lr)}else waitingDialog.show("No data returned","Error",{dialogSize:"m",hasbtn:!0})})}function P(e,r){if(r){Jr=r.cytobands,Zr=r.centers;var t=0;if(r.centers)for(var n=0;n<ar.length-1;n++){t=hr[ar[n+1]-1];var o=lr[n].replace(/chr/,"");vr[o]={chrLength:t,bands:Jr[o],centers:Zr[o],chr:o}}else for(var n=0;n<ar.length-1;n++){t=hr[ar[n+1]-1];var o=lr[n].replace(/chr/,"");vr[o]={chrLength:t,bands:Jr[o],chr:o}}j&&w(j)}}function z(e){e=Er+e,d3.json(e,P)}function G(e,r,t,n){if(t&&vr){e=lr[e-1],e=e.replace(/chr/,"");var o=vr[e];if(o){var a=20,i=$(r).parent().width(),l=d3.scale.linear().domain([0,o.chrLength]).range([5,i-10]);U.append("svg:rect").attr("class","highlight_region").attr("height",a).attr("width",l(t.end)-l(t.start)).attr("x",l(t.start)).attr("y",20).attr("stroke","transparent").attr("fill",d3.rgb(255*n.r,255*n.g,255*n.b)).attr("fill-opacity",.5)}}}function _(){var e=$(".pastisMethod").val(),r=Er+"/buildModel/"+e;waitingDialog.show("Predicting Model, please wait ...","Model Prediction",{dialogSize:"m",progressType:"warning"}),$.getJSON(r,function(e){if(waitingDialog.hide(),Object.keys(e).length>0)if(e.hasOwnProperty("error"))waitingDialog.show(e.error,"Error",{dialogSize:"m",hasbtn:!0});else{if(e.hasOwnProperty("genome")&&e.genome.length>0)for($("#genomes").empty(),i=0;i<e.genome.length;i++)$("#genomes").append($("<option></option>").attr("value",e.genome[i].modelPath+"/"+e.genome[i].file).text(e.genome[i].name+"(res:"+e.genome[i].resolution+")"));waitingDialog.show("The model has been predicted successfully. Please load it from builded models.","Model Predicted Successfully",{dialogSize:"m",hasbtn:!0})}})}var k,j,F,L,V,Y,q,U,X,N,J,Z,W,K,Q,er,rr,tr,nr,or,ar,ir,lr,sr,cr,dr,hr,fr,gr,pr,ur,wr,vr,mr=!1,Er="/member/nadhir/HiC3DViewer",yr=null,br=1,Rr=1,Tr=0,Hr=1,Cr={"Yellow-Orange-Red":0,"Yellow-Orange-Brown":1,"Yellow-Green-Blue":2,"Yellow-Green":3,Red:4,"Red-Purple":5,Purple:6,"Purple-Red":7,"Purple-Blue-Green":8,"Purple-Blue":9,"Orange-Red":10,Oranges:11,Greys:12,Greens:13,"Green-Blue":14,"Blue-Purple":15,"Blue-Green":16,Blues:17},Mr=1,xr=$("#dis_HiC"),Ar=.93*$("#dis_HiC").width(),Or=.95*(window.innerHeight-100),Sr=new THREE.Scene,Dr=new THREE.Scene,$r=new dat.GUI({width:264}),Br=new Array,Ir=d3.scale.category10(),Pr=["#1f78b4","#a6cee3","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","#b15928","#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#d9d9d9","#bc80bd","#ccebc5","#ffed6f"],zr=!1,Gr=!1,_r=!1,kr=new THREE.Color(16768315),jr=new THREE.Color(16725044),Fr=16775163,Lr=16775163,Vr=new THREE.Vector3,Yr=new THREE.Vector3,qr=[[0,1,4],[1,4,5],[0,3,4],[3,4,7],[2,3,7],[2,6,7],[1,2,5],[2,5,6]],Ur=[[0,1,2],[0,2,3],[4,5,6],[4,6,7]],Xr="",Nr=new Array(8),Jr=new Array,Zr=new Array,Wr=new THREE.PerspectiveCamera(75,Ar/Or,.1,5e3),Kr=new THREE.WebGLRenderer({antialias:!0});Kr.setSize(Ar,Or),xr.append(Kr.domElement),Kr.autoClear=!1;var Qr=new THREE.OrbitControls(Wr,Kr.domElement);Qr.maxDistance=5e3,E(),window.addEventListener("resize",A,!1),x(),$("button.btnLoadExisting").click(function(){fr=$("select#genomes").find(":selected").text(),-1!=fr.search("res")?(fr=fr.split("(res:")[0],gr=$("select#genomes").find(":selected").text().split("(res:")[1],gr=gr.replace(")","")):gr=0,B(fr,gr,$("select#genomes").val())}),$("#fileUpload").fileupload({url:Er+"/uploadModel/0",dataType:"json",maxNumberOfFiles:1,acceptFileTypes:/(\.|\/)(txt|bed)$/i,add:function(e,r){r.context=$("button.submitPet").click(function(){r.submit();waitingDialog.exist()||waitingDialog.show("Uploading file, please wait ....","Uploading model",{dialogSize:"m",progressType:"warning"})})},done:function(e,r){if(waitingDialog.hide(),r.result.files.hasOwnProperty("error"))waitingDialog.show(r.result.files.error,"Error",{dialogSize:"m",hasbtn:!0});else if(r.result.genome.length>0){for($("#genomes").empty(),i=0;i<r.result.genome.length;i++)$("#genomes").append(0==r.result.genome[i].resolution?$("<option></option>").attr("value",r.result.genome[i].modelPath+"/"+r.result.genome[i].file).text(r.result.genome[i].name):$("<option></option>").attr("value",r.result.genome[i].modelPath+"/"+r.result.genome[i].file).text(r.result.genome[i].name+"(res:"+r.result.genome[i].resolution+")"));waitingDialog.show("Your model has been loaded successfully. Please load it from builded models.","Model Uploaded Successfully",{dialogSize:"m",hasbtn:!0})}}}),$("button.btnLoadSpecies").click(function(){if(X=$("select#species").find(":selected").text(),X=X.split("(")[0],vr=new Array,ar){var e="/data/"+X+"/cytobands.json";z(e)}var r="div#regionInfo";$(r).empty(),X&&"Others"!=X&&waitingDialog.show(X+" cytobands load successfully.","",{dialogSize:"m",hasbtn:!0})}),$("#annotUpload").fileupload({url:Er+"/annotRegions",dataType:"json",acceptFileTypes:/(\.|\/)(txt|bed)$/i,add:function(e,r){r.context=$("button.submitAnnot").click(function(){r.submit();S(r.files)})}}),DisplayChromosome=function(e,r,t,n,o,a){if(vr){e=lr[e-1],e=e.replace(/chr/,"");var i=vr[e],l=20,s=$(r).parent().width();U=d3.select(r).append("div").attr("class","chrDiv").attr("width",s).attr("height",l+30).append("svg").attr("width",s).attr("height",l+30).append("g").attr("class","chromSVG").attr("stroke","black").attr("transform","translate(0, 5)");for(var c,d=n-t;d>0;)c?(c=d%1e3+","+c,Math.floor(d/1e3)>0&&(10>d%1e3?c="00"+c:100>d%1e3&&(c="0"+c))):(c=d%1e3,10>c?c="00"+c:100>c&&(c="0"+c)),d=Math.floor(d/1e3);for(var h,f=a-o;f>0;)h?(h=f%1e3+","+h,Math.floor(f/1e3)>0&&(10>f%1e3?h="00"+h:100>f%1e3&&(h="0"+h))):(h=f%1e3,10>h?h="00"+h:100>h&&(h="0"+h)),f=Math.floor(f/1e3);for(var g;t>0;)g?(g=t%1e3+","+g,Math.floor(t/1e3)>0&&(10>t%1e3?g="00"+g:100>t%1e3&&(g="0"+g))):(g=t%1e3,10>g?g="00"+g:100>g&&(g="0"+g)),t=Math.floor(t/1e3);for(var p;o>0;)p?(p=o%1e3+","+p,Math.floor(o/1e3)>0&&(10>o%1e3?p="00"+p:100>o%1e3&&(p="0"+p))):(p=o%1e3,10>p?p="00"+p:100>p&&(p="0"+p)),o=Math.floor(o/1e3);for(var u;n>0;)u?(u=n%1e3+","+u,Math.floor(n/1e3)>0&&(10>n%1e3?u="00"+u:100>n%1e3&&(u="0"+u))):(u=n%1e3,10>u?u="00"+u:100>u&&(u="0"+u)),n=Math.floor(n/1e3);for(var w;a>0;)w?(w=a%1e3+","+w,Math.floor(a/1e3)>0&&(10>a%1e3?w="00"+w:100>a%1e3&&(w="0"+w))):(w=a%1e3,10>w?w="00"+w:100>w&&(w="0"+w)),a=Math.floor(a/1e3);var v=d3.scale.linear().domain([0,i.chrLength]).range([5,s-10]);U.append("text").style("font-family","helvetica, arial, sans-serif").style("font-size","14px").attr("x",0).attr("y",12).text("Regions: "+g+"bp ~ "+u+"bp ( length: "+c+"bp ) & "+p+"bp ~ "+w+"bp ( length: "+h+"bp )");var m=U.selectAll(".chr").data(i.bands);if(m.enter().append("rect").attr("class",function(e){return"chr "+e.fill}).attr("height",l).attr("width",function(e){return v(e.end)-v(e.start)}).attr("x",function(e){return v(e.start)}).attr("y",20),i.centers){var E=U.selectAll(".centro").data(i.centers);E.enter().append("path").attr("class",function(e){return"centro "+e.fill}).attr("d",function(e){return"acen1"==e.fill?"M "+v(e.start)+" "+String(20)+" L "+v(e.end)+" "+String(30)+" L "+v(e.start)+" "+String(40)+" Z":"M "+v(e.start)+" 30 L "+v(e.end)+" 20 L "+v(e.end)+" 40 Z"})}}},$(".submitHiC").click(function(){var e=new FormData,r=$('input[type="file"][id="hiCupload"]')[0],t=$('input[type="file"][id="chrLenghtUpload"]')[0];if(0==r.files.length)return void waitingDialog.show("Please select Hi-C frequency matrix file","Error",{dialogSize:"m",hasbtn:!0});if(0==t.files.length)return void waitingDialog.show("Please select the chromosome lenghts files","Error",{dialogSize:"m",hasbtn:!0});var n=r.files[0],o=t.files[0];e.append("Hic",n),e.append("chrLengths",o);var a=$("#hicResolution").val();""==a&&(a=1e6),e.append("resolution",a),waitingDialog.show("Uploading files, please wait ...","Uploading Hi-C files",{dialogSize:"m",progressType:"warning"}),$.ajax({url:Er+"/uploadHic",data:e,cache:!1,contentType:!1,processData:!1,type:"POST",success:function(e){if(waitingDialog.hide(),"error"in e){var r="Error while uploading the file : "+e.error;return void waitingDialog.show(r,"Error",{dialogSize:"m",hasbtn:!0})}"success"in e&&_()}})})});