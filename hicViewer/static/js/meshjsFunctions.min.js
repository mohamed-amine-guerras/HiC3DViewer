$(document).ready(function(){var h=$("#dis_HiC").width();var O=h;var T=$("#dis_HiC");var J=new THREE.Scene();var z=new THREE.PerspectiveCamera(75,h/O,0.1,3000);var V=new THREE.WebGLRenderer({antialias:true});var K;var Q;var p;var H=false;var aj=new THREE.Color(16768315);var d=new THREE.Color(16725044);var Y=new THREE.Color(16772512);var s=new THREE.Color(16775163);var o=new THREE.Vector3();var ab=new THREE.Projector();var j=false;var D=null;var an=new THREE.Vector3();var G=new THREE.Vector3();var w=new THREE.Vector3();var aq="";var W={fontsize:32,backgroundColor:{r:255,g:100,b:100,a:1}};var ao=new Array();V.setSize(h,O);V.sortObjects=false;V.setClearColor(0,1);J.add(z);z.position.z=300;V.setSize(h,O);T.append(V.domElement);K=new THREE.OrbitControls(z,V.domElement);binFacesIndex=new Array();Regions=new Array();var m=["#1f78b4","#a6cee3","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","#b15928","#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#d9d9d9","#bc80bd","#ccebc5","#ffed6f"];var n=[];var e=true;var E=false;var v=false;var u=false;var t=false;var ad=null;var S=4;var ag=S;var ac=Math.pow(2,53)-1;var P=function(at){var ar=at&&at.length;return typeof ar=="number"&&ar>=0&&ar<=ac};$("#aboutlnk").click(function(){aboutDialog.show()});function C(at,aB,aA,ay,ax){var az=new THREE.BoxGeometry(1,1,1);var av=new THREE.MeshBasicMaterial({color:m[at]});var ar=new THREE.Mesh(az,av);ar.position.x=aA+2;ar.position.y=ay+2;ar.position.z=ax+2;ar.matrixAutoUpdate=false;ar.updateMatrix();if(e){var aw=n[at].faces.length;n[at].merge(ar.geometry,ar.matrix);var au={start:aw,end:(n[at].faces.length-1)};binFacesIndex[at][aB]={coord:au,region:undefined}}else{n[at].add(ar)}}function Z(aC,aA,ay,ax,ar,aB){var aw=new THREE.Vector3(ao[aC][ay].x+2,ao[aC][ay].y+2,ao[aC][ay].z+2);var au=new THREE.Vector3(ao[aA][ax].x+2,ao[aA][ax].y+2,ao[aA][ax].z+2);var av=new THREE.Geometry();opacity=Math.min(ar,aB)/aB;var az=s.clone();var at=new THREE.LineBasicMaterial({color:az,transparent:true,opacity:opacity,linewidth:2});av.vertices=[aw,au];line=new THREE.Line(av,at);if(aC==aA){Q.add(line)}else{p.add(line)}}function k(az,ay){if(ad==null){ad=new dat.GUI()}else{al()}var av={x:false,y:false,z:false,"trans-interactions":false,v:"...","display all":true};ad.add(av,"display all").onChange(function(aB){for(var aA=0;aA<ad.__folders["Chromosomes visibility"].__controllers.length;aA++){az[Object.keys(ay)[aA]]=aB;var aC=parseInt(Object.keys(ay)[aA].replace(/chr/,""),10);n[aC].visible=aB;ad.__folders["Chromosomes visibility"].__controllers[aA].updateDisplay()}});var ar=ad.addFolder("Chromosomes visibility");for(var aw=0;aw<Object.keys(az).length;aw++){var ax=ar.add(az,Object.keys(az)[aw]).listen();ax.onChange(function(aA){var aB=parseInt(this.property.replace(/chr/,""),10);n[aB].visible=aA})}ar.open();var au=ad.addFolder("chromosomes color");for(var aw=0;aw<Object.keys(ay).length;aw++){au.addColor(ay,Object.keys(ay)[aw]).onChange(function(aA){var aB=parseInt(this.property.replace(/chr/,""),10);if(e){n[aB].material.materials[0].color.setHex(aA.replace("#","0x"))}})}au.open();var at=ad.addFolder("Rotate");at.add(av,"x").onChange(function(aA){v=aA});at.add(av,"y").onChange(function(aA){u=aA});at.add(av,"z").onChange(function(aA){t=aA});ad.add(av,"trans-interactions").onChange(function(aC){if(p instanceof THREE.Object3D){p.visible=aC}else{if(!aC){return}var aA=$("#genomes option:selected").text();data={genome:aA};if(D!=null){data.chromosomes=Object.keys(D)}var aB="/getInter";$.ajax({type:"POST",url:aB,contentType:"application/json",dataType:"json",data:JSON.stringify(data),success:function(aF){if(Object.keys(aF).length>0){var aD=100;if(aF.hasOwnProperty("maxFreq")){aD=aF.maxFreq}if(aF.hasOwnProperty("interactions")){aF=aF.interactions}else{return}p=new THREE.Object3D();for(var aE=0;aE<Object.keys(aF).length;aE++){Z(aF[aE].chr1,aF[aE].chr2,aF[aE].pos1,aF[aE].pos2,aF[aE].freq,aD)}}J.add(p)}})}});ad.add(av,"v",Object.keys(ay)).name("cis interactions").onChange(function(aD){var aC=parseInt(aD.replace(/chr/,""),10);var aA=$("#genomes option:selected").text();var aB="/getIntra/"+aA+"/"+aC;$.getJSON(aB,function(aI){if(Object.keys(aI).length>0){if(Q){J.remove(Q)}var aE=100;if(aI.hasOwnProperty("maxFreq")){aE=aI.maxFreq}if(aI.hasOwnProperty("interactions")){aI=aI.interactions}else{return}Q=new THREE.Object3D();for(var aF=0;aF<Object.keys(aI).length;aF++){var aG=Object.keys(aI)[aF];var aJ=aI[aG];for(var aH=1;aH<Object.keys(aJ).length;aH++){Z(aG,aG,aJ[aH].pos1,aJ[aH].pos2,aJ[aH].freq,aE)}}}J.add(Q)})});ad.open()}function af(){var at,ar;for(ar=J.children.length-1;ar>=0;ar--){at=J.children[ar];if(at!==z){J.remove(at)}}}function al(){var ar;for(var au in ad.__folders){if(ad.__folders.hasOwnProperty(au)){var at=ad.__folders[au];at.close();ad.__ul.removeChild(at.domElement.parentNode);delete ad.__folders[au]}}for(ar=0;ar<ad.__controllers.length;ar++){ad.__ul.removeChild(ad.__controllers[ar].__li)}ad.__controllers=[];ad.onResize()}function B(ar,av,au){var at="/displayHic/"+ar+"/"+av+"/"+au;$.getJSON(at,function(aw){if(Object.keys(aw).length>0){if(aw.hasOwnProperty("error")){return}var ax="Hi-C contact map of "+ar;var ay="/getHicImg/"+aw.imgUrl;chrIndex=aw.chrInfo;hicDialog.show(ax,ar,ay,chrIndex)}else{waitingDialog.show("No data returned","Error",{dialogSize:"m",hasbtn:true})}})}function l(ar){var at=new THREE.Object3D();at.add(ai(new THREE.Vector3(0,0,0),new THREE.Vector3(ar,0,0),14102567,false));at.add(ai(new THREE.Vector3(0,0,0),new THREE.Vector3(-ar,0,0),14102567,true));at.add(ai(new THREE.Vector3(0,0,0),new THREE.Vector3(0,ar,0),6733155,false));at.add(ai(new THREE.Vector3(0,0,0),new THREE.Vector3(0,-ar,0),6733155,true));at.add(ai(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,ar),3311805,false));at.add(ai(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,-ar),3311805,true));return at}function ai(ax,ay,at,ar){var av=new THREE.Geometry(),au;if(ar){au=new THREE.LineDashedMaterial({linewidth:3,color:at,dashSize:3,gapSize:3})}else{au=new THREE.LineBasicMaterial({linewidth:3,color:at})}av.vertices.push(ax.clone());av.vertices.push(ay.clone());av.computeLineDistances();var aw=new THREE.Line(av,au,THREE.LinePieces);return aw}function ae(ar){return toString.call(ar)=="[object Arguments]"}function I(ay,au,az,aC){var at=[],aB=0;for(var aw=aC||0,ar=ay&&ay.length;aw<ar;aw++){var aA=ay[aw];if(P(aA)&&(Array.isArray(aA)||ae(aA))){if(!au){aA=I(aA,au,az)}var av=0,ax=aA.length;at.length+=ax;while(av<ax){at[aB++]=aA[av++]}}else{if(!az){at[aB++]=aA}}}return at}function A(ay,az,av){var ar={},au;if(ay==null){return ar}var ax=I(arguments,false,false,1);ay=new Object(ay);for(var at=0,aw=ax.length;at<aw;at++){au=ax[at];if(au in ay){ar[au]=ay[au]}}return ar}function R(){an=new THREE.Vector3(9999,9999,9999);G=new THREE.Vector3(-9999,-9999,-9999);w=new THREE.Vector3();for(var aw in ao){n[aw]=e?new THREE.Geometry():new THREE.Object3D();binFacesIndex[aw]=new Array(ao[aw].length);for(var at=0;at<ao[aw].length;at++){var av=ao[aw][at];C(aw,at,av.x,av.y,av.z);var ay=new THREE.Vector3(av.x,av.y,av.z);w.add(ay);an.min(ay);G.max(ay)}n[aw].computeFaceNormals();var ar=new THREE.MeshBasicMaterial({color:m[aw],vertexColors:THREE.VertexColors,shading:THREE.FlatShading});var au=[ar];n[aw]=new THREE.Mesh(n[aw],new THREE.MeshFaceMaterial(au));n[aw].matrixAutoUpdate=false;n[aw].updateMatrix();for(var ax=0;ax<n[aw].geometry.faces.length;ax++){n[aw].geometry.faces[ax].materialIndex=0}n[aw].chromosome=aw;J.add(n[aw])}x()}function U(){var ax=1;var aw=Object.keys(ao).length;if(aw<S){S=aw}else{ax=Math.ceil(aw/S)}an=new THREE.Vector3(9999,9999,9999);G=new THREE.Vector3(-9999,-9999,-9999);w=new THREE.Vector3();var av=Object.keys(ao);var ar=0;var at;ag=0;for(var au=0;au<S;au++){var az=av.slice(ar,ar+ax);var ay=A(ao,az);at=new Worker("/static/js/worker.js");at.onmessage=M;at.postMessage({chrs:ay,ids:az,col:m});ag++;ar+=ax}}function M(az){ag--;if(az.type=="error"){alert("Error when displaying chromosomes in worker "+ag);return}var au=new THREE.JSONLoader();w.add(new THREE.Vector3(az.data.psum.x,az.data.psum.y,az.data.psum.z));an.min(new THREE.Vector3(az.data.pmin.x,az.data.pmin.y,az.data.pmin.z));G.max(new THREE.Vector3(az.data.pmax.x,az.data.pmax.y,az.data.pmax.z));for(var at=0;at<az.data.ids.length;at++){var ax=az.data.ids[at];binFacesIndex[ax]=az.data.binFacesIndex[ax];n[ax]=new THREE.Geometry();var aw=au.parse(az.data.geometies[ax]);var ar=new THREE.MeshBasicMaterial({color:m[ax],vertexColors:THREE.VertexColors,shading:THREE.FlatShading});var av=[ar];n[ax]=new THREE.Mesh(aw.geometry,new THREE.MeshFaceMaterial(av));n[ax].chromosome=ax;n[ax].matrixAutoUpdate=false;n[ax].updateMatrix();for(var ay=0;ay<n[ax].geometry.faces.length;ay++){n[ax].geometry.faces[ay].materialIndex=0}J.add(n[ax])}if(ag==0){x()}}function x(){var ar={};var ax={};for(var au in n){var at="chr"+au;ar[at]=true;ax[at]=m[au]}z.position.z=G.z*1.5;z.position.x=(an.x+G.y)/2;z.position.y=(an.y+G.y)/2;N();var aw=l(200);J.add(aw);k(ar,ax);function av(){requestAnimationFrame(av);z.lookAt(J.position);if(v||u||t){var aC=Date.now()*0.001;var aB=Math.sin(aC*0.7)*0.5,aA=Math.sin(aC*0.3)*0.5,az=Math.sin(aC*0.2)*0.5;for(var ay=1;ay<n.length;ay++){if(v){n[ay].rotation.x+=aB}if(u){n[ay].rotation.y+=aA}if(t){n[ay].rotation.z+=az}}}V.render(J,z)}av();K.update();waitingDialog.hide();B(aq,1,1);$(document).on("regionSelected",am);$(document).on("clearHic",function(ay){c()});$(document).on("chrChanged",b)}function N(){hemiLight=new THREE.HemisphereLight(16777215,16777215,0.6);hemiLight.color.setHSL(0.6,1,0.6);hemiLight.groundColor.setHSL(0.095,1,0.75);hemiLight.position.set(0,500,0);J.add(hemiLight);dirLight=new THREE.DirectionalLight(16777215,1);dirLight.color.setHSL(0.1,1,0.95);dirLight.position.set(-1,1.75,1);dirLight.position.multiplyScalar(50);J.add(dirLight);dirLight.castShadow=true;dirLight.shadowMapWidth=2048;dirLight.shadowMapHeight=2048;var ar=50;dirLight.shadowCameraLeft=-ar;dirLight.shadowCameraRight=ar;dirLight.shadowCameraTop=ar;dirLight.shadowCameraBottom=-ar;dirLight.shadowCameraFar=3500;dirLight.shadowBias=-0.0001;dirLight.shadowDarkness=0.35}function aa(ar,au){waitingDialog.show("Loading model, please wait ....","Model Generation",{dialogSize:"sm",progressType:"warning"});aq=ar;var at="/getChr/"+ar+"/"+au;$.getJSON(at,function(av){if(Object.keys(av).length>0){if("error" in av){console.log("error")}else{ao=av;av=null;n=Array(Object.keys(ao).length);binFacesIndex=Array(n.length);af();if(typeof(Worker)=="undefined"){R(ao)}else{U(ao)}}}})}$("#fileupload").fileupload({url:"/uploadModel/"+1000000,dataType:"json",maxNumberOfFiles:1,acceptFileTypes:/(\.|\/)(txt|bed)$/i,add:function(at,ar){ar.context=$("button.submitPet").click(function(){ar.context=$('<span id="fileUploadRate">').text("0%").appendTo($(this));var au=ar.submit();waitingDialog.show("Uploading file, please wait ....","Uploading model",{dialogSize:"sm",progressType:"warning"})})},done:function(at,ar){$("button.petUpload").removeAttr("disabled");waitingDialog.hide();if(ar.result.files.hasOwnProperty("error")){waitingDialog.show(ar.result.files["error"],"Error",{dialogSize:"m",hasbtn:true})}else{if(ar.result.genome.length>0){$("#genomes").empty();for(i=0;i<ar.result.genome.length;i++){$("#genomes").append($("<option></option>").attr("value",ar.result.genome[i]["resolution"]).text(ar.result.genome[i]["name"]))}}}},progressall:function(au,at){var ar=parseInt(at.loaded/at.total*100,10);$("div#fileuploadProgressBar").css("width",ar+"%");$("div.progress-bar-container").attr("qtip-val",ar);$("span#fileUploadRate").text(ar+"%")}});function ah(){var at=$(".pastisMethod").val();var at=$(".pastisMethod").val();var ar="/buildModel/"+at;$.getJSON(ar,function(au){if(Object.keys(au).length>0){if(au.hasOwnProperty("error")){waitingDialog.show(au.error,"Error",{dialogSize:"m",hasbtn:true})}else{if(au.hasOwnProperty("genome")){if(au.genome.length>0){$("#genomes").empty();for(i=0;i<au.genome.length;i++){$("#genomes").append($("<option></option>").attr("value",au.genome[i]["resolution"]).text(au.genome[i]["name"]))}}}}}})}$(".submitHiC").click(function(){var av=new FormData();var aw=$('input[type="file"][id="hiCupload"]')[0];var ax=$('input[type="file"][id="chrLenghtUpload"]')[0];if(aw.files.length==0){waitingDialog.show("Please select Hi-C frequency matrix file","Error",{dialogSize:"m",progressType:"warning",hasbtn:true});return}if(ax.files.length==0){waitingDialog.show("Please select the chromosome lenghts files","Error",{dialogSize:"m",progressType:"warning",hasbtn:true});return}var au=aw.files[0];var ar=ax.files[0];av.append("Hic",au);av.append("chrLengths",ar);var at=$("#hicResolution").val();var ay=$(".pastisMethod").val();if(at==""){at=1000000}av.append("resolution",at);waitingDialog.show("Upload files, please wait ...","Uploading Hi-C files",{dialogSize:"m",progressType:"warning"});$.ajax({url:"/uploadHic",data:av,cache:false,contentType:false,processData:false,type:"POST",success:function(az){waitingDialog.hide();if("error" in az){var aA="Error while uploading the file : "+az.error;waitingDialog.show(aA,"Error",{dialogSize:"m",progressType:"warning",hasbtn:true});return}else{if("success" in az){ah()}}}})});function F(aw,ar,au,at,aA){for(var ax=ar;ax<=au;ax++){var az=n[aw].geometry.faces[ax];az.region=aA;var ay=(az instanceof THREE.Face3)?3:4;for(var av=0;av<ay;av++){az.vertexColors[av]=at}}}function q(at,aw,ar){for(var av=aw;av<=ar;av++){var au=n[at].geometry.faces[av];au.vertexColors=new Array();au.region=undefined}}function c(){for(var au in Regions){for(var at=0;at<Regions[au].length;at++){var ar=Regions[au][at];q(au,ar.start.start,ar.stop.end)}n[au].geometry.colorsNeedUpdate=true}Regions=new Array(n.length)}function L(au){c();D=au;for(var av in au){Regions[av]=new Array(au[av].length);var aw=d3.scale.category10();for(var az=0;az<au[av].length;az++){var aA=aj.clone();var at=au[av][az];if(at.hasOwnProperty("region")){aA=new THREE.Color(aw(at.region))}else{aA.lerp(d,at.freq)}var ar=binFacesIndex[av][at.binStart]["coord"];var ay=binFacesIndex[av][at.binStop]["coord"];Regions[av][az]={start:ar,stop:ay,name:at.name};F(av,ar.start,ay.end,aA,az);for(var ax=at.binStart;ax<=at.binStop;ax++){binFacesIndex[av][at.binStart]["region"]=az}}n[av].geometry.colorsNeedUpdate=true}}function X(){var ar="/annotRegions";$.getJSON(ar,function(at){if(Object.keys(at).length>0){if(at.hasOwnProperty("bins")){L(at.bins)}if(at.hasOwnProperty("genomicRegions")){hicDialog.displayRegions(at.genomicRegions)}}})}function am(ar){var at={};at.xcoord=ar.Xcoord;at.ycoord=ar.Ycoord;at.chr1=ar.chr1;at.chr2=ar.chr2;$.ajax({type:"POST",url:"/annotBrush",contentType:"application/json",dataType:"json",data:JSON.stringify(at),success:function(au){if(Object.keys(au).length>0){L(au)}},error:function(au,av){alert(av)}})}$("#annotUpload").fileupload({url:"/annotRegions",dataType:"json",acceptFileTypes:/(\.|\/)(txt|bed)$/i,add:function(at,ar){ar.context=$("button.submitAnnot").click(function(){var au=ar.submit()})},done:function(at,ar){X()},progressall:function(au,at){var ar=parseInt(at.loaded/at.total*100,10);$("div#fileuploadProgressBar").css("width",ar+"%");$("div.progress-bar-container").attr("qtip-val",ar);$("span#fileUploadRate").text(ar+"%")}});function b(at){var ar=$("select#genomes").find(":selected").text();B(ar,at.chr1,at.chr2)}$("button.btnLoadExisting").click(function(){var ar=$("select#genomes").find(":selected").text();var at=$("select#genomes").val();aa(ar,at)});window.addEventListener("resize",g,false);function g(av){var au=T.width();var at=T.height();var ar=Math.min(au,at);V.setSize(ar,ar);z.aspect=1;z.updateProjectionMatrix()}T.mousedown(ak);function ak(ar){ar.preventDefault();j=true}T.mouseup(ap);function ap(ar){j=false}T.mousemove(a);function a(az){az.preventDefault();if(j){return}var aB=new THREE.Color(16777011);var au=T.offset().left;var at=T.offset().top;o.x=2*((az.clientX-au)/T.width())-1;o.y=1-2*((az.clientY-at)/T.height());var aA=ab.pickingRay(o.clone(),z);var ay=aA.intersectObjects(J.children,true);if(ay.length==0){return}for(var ax=0;ax<ay.length;ax++){if(ay[ax].object.visible){if(!ay[ax].object.hasOwnProperty("chromosome")){return}var aw=ay[ax].object.chromosome;if(!ay[ax].hasOwnProperty("face")){return}var ar=ay[ax].face.region;if(ar==undefined){return}var av=Regions[aw][ar];$("#regionIfno").text("Chromosome: "+aw+" Region: "+av.name);return}}}function f(aw,at,au){var aB=[new THREE.Vector3(-9999,-9999,-9999),new THREE.Vector3(-9999,-9999,-9999)];var aA=["a","b","c","d"];var aD=[at,au];n[aw].geometry.faces[at];for(var az=0;az<aD.length;az++){var aC=n[aw].geometry.faces[aD[az]];var ay=(aC instanceof THREE.Face3)?3:4;for(var av=0;av<ay;av++){var ar=aC[aA[av]];var ax=n[aw].geometry.vertices[ar];aB[az].max(ax)}}var aE=aB[0].add(aB[1]).multiplyScalar(0.5);aE.y+=10;return(aE)}function r(aF,aE){if(aE===undefined){aE={}}var av=aE.hasOwnProperty("fontface")?aE.fontface:"Arial";var aA=aE.hasOwnProperty("fontsize")?aE.fontsize:18;var aw=aE.hasOwnProperty("borderThickness")?aE.borderThickness:4;var au=aE.hasOwnProperty("borderColor")?aE.borderColor:{r:0,g:0,b:0,a:1};var aC=aE.hasOwnProperty("backgroundColor")?aE.backgroundColor:{r:255,g:255,b:255,a:1};var at=document.createElement("canvas");var ar=at.getContext("2d");ar.font="Bold "+aA+"px "+av;var aB=ar.measureText(aF);var az=aB.width;ar.fillStyle="rgba("+aC.r+","+aC.g+","+aC.b+","+aC.a+")";ar.strokeStyle="rgba("+au.r+","+au.g+","+au.b+","+au.a+")";ar.lineWidth=aw;y(ar,aw/2,aw/2,az+aw,aA*1.4+aw,6);ar.fillStyle="rgba(0, 0, 0, 1.0)";ar.fillText(aF,aw,aA+aw);var ay=new THREE.Texture(at);ay.needsUpdate=true;var ax=new THREE.SpriteMaterial({map:ay,useScreenCoordinates:false});var aD=new THREE.Sprite(ax);aD.scale.set(100,50,1);return aD}function y(au,ar,ax,at,av,aw){au.beginPath();au.moveTo(ar+aw,ax);au.lineTo(ar+at-aw,ax);au.quadraticCurveTo(ar+at,ax,ar+at,ax+aw);au.lineTo(ar+at,ax+av-aw);au.quadraticCurveTo(ar+at,ax+av,ar+at-aw,ax+av);au.lineTo(ar+aw,ax+av);au.quadraticCurveTo(ar,ax+av,ar,ax+av-aw);au.lineTo(ar,ax+aw);au.quadraticCurveTo(ar,ax,ar+aw,ax);au.closePath();au.fill();au.stroke()}});